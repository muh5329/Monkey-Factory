version: '3.8'

services:
  server:
    build:
      context: .
      dockerfile: Dockerfile
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=production
 
  caddy:
    image: caddy:latest
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile
      - caddy_data:/data
      - caddy_config:/config

  plausible:
    image: plausible/analytics:latest
    ports:
      - "8000:8000"
    environment:
      - PLAUSIBLE_DB_DRIVER=sqlite
      - PLAUSIBLE_DOMAIN=localhost
      - PLAUSIBLE_SECRET_KEY=your_secret_key
    volumes:
      - plausible_data:/plausible/data

  prometheus:
    image: prom/prometheus
    ports:
      - "9090:9090"
    volumes:
      - ./prometheus:/etc/prometheus
    command:
      - "--config.file=/etc/prometheus/prometheus.yml"
      - "--storage.tsdb.path=/prometheus"
      - "--web.enable-admin-api"

volumes:
  caddy_data:
  caddy_config:
  plausible_data: